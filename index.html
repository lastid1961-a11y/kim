<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Global Smart Travel AI</title>
    
    <!-- SNS 공유 최적화 -->
    <meta property="og:title" content="나의 스마트 AI 여행 가이드">
    <meta property="og:description" content="AI 비서와 함께하는 전 세계 여행 올인원 앱">
    <meta property="og:image" content="https://images.unsplash.com/photo-1488646953014-85cb44e25828?auto=format&fit=crop&q=80&w=1000">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; overflow-x: hidden; color: #1e293b; }
        .glass-panel { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.5); }
        .tab-active { color: #2563eb; position: relative; font-weight: 800; }
        .tab-active::after { content: ''; position: absolute; bottom: -6px; left: 50%; transform: translateX(-50%); width: 20px; height: 4px; background: #2563eb; border-radius: 10px; }
        #map { height: 260px; width: 100%; border-radius: 32px; z-index: 10; border: 4px solid white; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05); }
        .pulse-mic { animation: pulse 1.5s infinite; background: #ef4444 !important; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.6); } 70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .trip-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .trip-card:active { transform: scale(0.96); }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 5000; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(8px); }
        .modal.active { display: flex; }
        .input-focus:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1); }
    </style>
</head>
<body class="pb-36">

    <div class="max-w-md mx-auto min-h-screen bg-slate-50 relative shadow-2xl overflow-hidden">
        
        <!-- Header -->
        <header class="p-6 pb-2 sticky top-0 bg-slate-50/90 backdrop-blur-md z-[100] border-b border-slate-200/30">
            <div class="flex justify-between items-center">
                <button onclick="switchTab('settings')" class="flex items-center gap-3 group">
                    <div class="p-2.5 bg-blue-600 rounded-2xl group-active:scale-90 transition-transform shadow-lg shadow-blue-200">
                        <i data-lucide="briefcase" class="w-5 h-5 text-white"></i>
                    </div>
                    <div class="text-left">
                        <h1 id="current-trip-name" class="text-sm font-black tracking-tight text-slate-900 leading-none">여행 로딩 중...</h1>
                        <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-1">Trip Manager</p>
                    </div>
                </button>
                <div class="flex gap-2">
                    <button onclick="openShareModal()" class="p-3 bg-white rounded-2xl shadow-sm text-blue-600 hover:bg-blue-50 transition-all border border-slate-100">
                        <i data-lucide="share-2" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Dynamic Status Board -->
        <div class="px-6 mb-6 mt-4">
            <div class="bg-slate-900 p-6 rounded-[2.5rem] text-white shadow-2xl relative overflow-hidden">
                <div class="relative z-10">
                    <div class="flex justify-between items-center mb-5">
                        <div class="flex items-center gap-2 bg-white/10 px-3 py-1.5 rounded-full border border-white/10">
                            <i data-lucide="coins" class="w-3.5 h-3.5 text-blue-400"></i>
                            <span id="current-currency" class="text-[10px] font-black uppercase">KRW</span>
                        </div>
                        <div id="clock" class="text-xs font-mono font-bold opacity-50">00:00:00</div>
                    </div>
                    <h2 id="ai-suggestion" class="text-xl font-bold leading-tight tracking-tight min-h-[3rem]">AI 가이드를 <br>불러오는 중...</h2>
                    <div class="mt-4 flex gap-4 items-center">
                        <div class="flex flex-col">
                            <span class="text-[8px] font-bold opacity-40 uppercase tracking-widest">Exchange Rate</span>
                            <span id="rate-display" class="text-xs font-black">1.00 KRW = 1.00 USD</span>
                        </div>
                    </div>
                </div>
                <!-- Abstract Decor -->
                <div class="absolute -right-16 -top-16 w-56 h-56 bg-blue-600/30 rounded-full blur-[80px]"></div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <nav class="flex px-8 mb-6 justify-between items-center border-b border-slate-200/50 overflow-x-auto no-scrollbar gap-8">
            <button onclick="switchTab('plan', this)" class="pb-3 text-xs font-bold text-slate-400 tab-active whitespace-nowrap uppercase tracking-tighter">Plan</button>
            <button onclick="switchTab('expense', this)" class="pb-3 text-xs font-bold text-slate-400 whitespace-nowrap uppercase tracking-tighter">Budget</button>
            <button onclick="switchTab('gallery', this)" class="pb-3 text-xs font-bold text-slate-400 whitespace-nowrap uppercase tracking-tighter">Gallery</button>
            <button onclick="switchTab('memo', this)" class="pb-3 text-xs font-bold text-slate-400 whitespace-nowrap uppercase tracking-tighter">Note</button>
        </nav>

        <!-- Main View -->
        <main class="px-6 min-h-[50vh]">
            
            <!-- PLAN -->
            <section id="tab-plan" class="space-y-6 fade-in">
                <div id="map"></div>
                <div class="flex justify-between items-center">
                    <h3 class="font-black text-slate-900 flex items-center gap-2 text-xs uppercase tracking-widest">Routes</h3>
                    <button onclick="addNewPlan()" class="px-4 py-2 bg-blue-600 text-white rounded-2xl text-[10px] font-black shadow-lg shadow-blue-100 flex items-center gap-1">
                        <i data-lucide="plus" class="w-3 h-3"></i> ADD
                    </button>
                </div>
                <div id="plan-list" class="space-y-3 pb-4"></div>
            </section>

            <!-- EXPENSE -->
            <section id="tab-expense" class="hidden space-y-6 fade-in">
                <div class="bg-gradient-to-br from-slate-800 to-slate-950 rounded-[2.5rem] p-7 text-white shadow-xl relative overflow-hidden">
                    <p class="text-[10px] uppercase font-black opacity-40 mb-1 tracking-widest">Total Expenses</p>
                    <h2 id="total-expense" class="text-3xl font-black">₩ 0</h2>
                    <div class="mt-6 flex justify-between items-center">
                        <span id="expense-count" class="text-[10px] font-bold bg-white/10 px-3 py-1 rounded-lg italic">0 entries</span>
                        <button onclick="openCurrencyModal()" class="text-[10px] font-black text-blue-400 flex items-center gap-1">
                            <i data-lucide="refresh-ccw" class="w-3 h-3"></i> 환율 변환기
                        </button>
                    </div>
                </div>

                <!-- Receipt Scanner -->
                <div class="bg-white rounded-3xl p-7 border-2 border-dashed border-slate-200 flex flex-col items-center text-center group active:bg-slate-50 transition-all cursor-pointer" onclick="document.getElementById('receipt-input').click()">
                    <div class="w-14 h-14 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center mb-4 transition-transform group-active:scale-90">
                        <i data-lucide="scan-line" class="w-7 h-7"></i>
                    </div>
                    <h4 class="text-sm font-black text-slate-800 uppercase tracking-tighter">Receipt Scanner</h4>
                    <p class="text-[10px] text-slate-400 mt-1 font-bold">영수증 사진을 찍으면 AI가 자동 계산합니다</p>
                    <input type="file" id="receipt-input" class="hidden" accept="image/*" onchange="scanReceipt(this)">
                </div>

                <div id="expense-list" class="space-y-3"></div>
            </section>

            <!-- GALLERY -->
            <section id="tab-gallery" class="hidden space-y-6 fade-in">
                <div class="flex justify-between items-center">
                    <h3 class="font-black text-slate-900 text-xs uppercase tracking-widest tracking-widest">Memory Bank</h3>
                    <label class="cursor-pointer bg-slate-900 text-white text-[10px] px-5 py-2.5 rounded-2xl font-black shadow-lg shadow-slate-200 transition-transform active:scale-95">
                        UPLOAD
                        <input type="file" class="hidden" accept="image/*" onchange="addGalleryImage(this)">
                    </label>
                </div>
                <div id="gallery-list" class="grid grid-cols-3 gap-3"></div>
            </section>

            <!-- SETTINGS / HISTORY -->
            <section id="tab-settings" class="hidden space-y-6 fade-in">
                <div class="bg-white rounded-[2rem] p-7 shadow-sm border border-slate-100 space-y-8">
                    <div>
                        <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-5">Travel Identity</h4>
                        <div class="space-y-5">
                            <div class="flex flex-col gap-2">
                                <label class="text-[10px] font-black text-slate-400 px-1">Trip Name</label>
                                <input type="text" id="set-trip-name" oninput="updateTripName(this.value)" class="w-full bg-slate-50 border-none rounded-2xl p-4 text-sm font-bold input-focus" placeholder="고성 여행 2026">
                            </div>
                            <div class="flex flex-col gap-2">
                                <label class="text-[10px] font-black text-slate-400 px-1">Main Currency</label>
                                <select id="set-currency" onchange="updateTripCurrency(this.value)" class="w-full bg-slate-50 border-none rounded-2xl p-4 text-sm font-bold outline-none">
                                    <option value="KRW">KRW (₩) - 대한민국 원</option>
                                    <option value="USD">USD ($) - 미국 달러</option>
                                    <option value="JPY">JPY (¥) - 일본 엔</option>
                                    <option value="EUR">EUR (€) - 유럽 유로</option>
                                    <option value="VND">VND (₫) - 베트남 동</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <hr class="opacity-50">
                    <div>
                        <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-5">Travel Archive</h4>
                        <div id="trip-history-list" class="space-y-3"></div>
                        <button onclick="createNewTrip()" class="w-full mt-6 py-4 bg-blue-50 text-blue-600 rounded-3xl text-xs font-black hover:bg-blue-100 transition-colors flex items-center justify-center gap-2">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i> 새로운 여행지 추가
                        </button>
                    </div>
                </div>
            </section>

            <!-- MEMO -->
            <section id="tab-memo" class="hidden space-y-6 fade-in">
                <div class="flex gap-2">
                    <input type="text" id="new-check-input" class="flex-1 bg-white border border-slate-200 rounded-2xl px-5 py-4 text-sm font-bold input-focus" placeholder="준비물을 추가하세요...">
                    <button onclick="addCheck()" class="p-4 bg-blue-600 text-white rounded-2xl shadow-lg shadow-blue-100 transition-transform active:scale-90"><i data-lucide="plus" class="w-6 h-6"></i></button>
                </div>
                <div id="check-list" class="space-y-2"></div>
                <textarea id="memo-field" oninput="saveCurrentData()" class="w-full h-56 bg-white border border-slate-200 rounded-[2rem] p-6 text-sm font-medium outline-none shadow-sm focus:ring-4 focus:ring-blue-500/5 transition-all" placeholder="여행의 순간들을 자유롭게 기록하세요..."></textarea>
            </section>
        </main>

        <!-- Share Modal (Magic Link) -->
        <div id="share-modal" class="modal">
            <div class="bg-white rounded-[3rem] p-9 w-full max-w-xs shadow-2xl text-center space-y-7">
                <div class="w-20 h-20 bg-blue-50 text-blue-600 rounded-[2.5rem] flex items-center justify-center mx-auto animate-bounce">
                    <i data-lucide="send" class="w-10 h-10"></i>
                </div>
                <div>
                    <h3 class="text-xl font-black text-slate-900 leading-tight">마법 링크 공유</h3>
                    <p class="text-xs text-slate-400 mt-3 font-medium">제미나이 로그인 없이도<br>내 일정을 그대로 전송합니다.</p>
                </div>
                <button onclick="copyShareLink()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black text-sm shadow-xl shadow-blue-200 active:scale-95 transition-all">
                    공유 링크 복사하기
                </button>
                <button onclick="closeShareModal()" class="text-[10px] font-black text-slate-300 uppercase tracking-[0.2em]">CLOSE</button>
            </div>
        </div>

        <!-- AI Floating Interface -->
        <div class="fixed bottom-8 left-1/2 -translate-x-1/2 w-[92%] max-w-sm glass-panel rounded-[3.5rem] p-4 flex justify-between items-center z-[2000] shadow-2xl border-white/50">
            <button onclick="switchTab('plan')" class="flex-1 flex flex-col items-center gap-1 text-slate-400" id="nav-plan">
                <i data-lucide="map" class="w-5 h-5"></i>
                <span class="text-[9px] font-black uppercase tracking-tighter">Guide</span>
            </button>
            
            <div class="relative -top-10">
                <button onclick="startAIVoice()" id="mic-btn" class="w-18 h-18 bg-blue-600 rounded-full flex items-center justify-center text-white shadow-2xl shadow-blue-400 transition-all active:scale-90 ring-8 ring-white/30 p-5">
                    <i data-lucide="mic" class="w-8 h-8"></i>
                </button>
                <div id="ai-loading" class="hidden absolute -top-14 left-1/2 -translate-x-1/2 bg-slate-900 text-white text-[9px] px-4 py-2 rounded-full whitespace-nowrap font-black shadow-xl animate-pulse">
                    ANALYZING...
                </div>
            </div>

            <button onclick="switchTab('expense')" class="flex-1 flex flex-col items-center gap-1 text-slate-400" id="nav-expense">
                <i data-lucide="wallet-2" class="w-5 h-5"></i>
                <span class="text-[9px] font-black uppercase tracking-tighter">Budget</span>
            </button>
        </div>

    </div>

    <script>
        const apiKey = ""; // Gemini API Key
        let map, markers = [];
        
        // --- Multi-Trip Database Structure ---
        let globalDB = JSON.parse(localStorage.getItem('gst_v4_db')) || {
            trips: [
                {
                    id: Date.now(),
                    name: "첫 번째 고성 여행",
                    currency: "KRW",
                    plans: [
                        { id: 101, title: '아야진 해변', time: '14:00', lat: 38.2721, lng: 128.5541 },
                        { id: 102, title: '백촌막국수', time: '12:00', lat: 38.2591, lng: 128.5562 }
                    ],
                    expenses: [],
                    gallery: [],
                    checks: [{ text: '신분증 지참하기', done: false }],
                    memo: ""
                }
            ],
            currentTripId: null,
            rates: { "USD": 1350, "JPY": 9, "EUR": 1450, "VND": 0.05, "KRW": 1 }
        };

        if (!globalDB.currentTripId && globalDB.trips.length > 0) {
            globalDB.currentTripId = globalDB.trips[0].id;
        }

        const getCurrentTrip = () => globalDB.trips.find(t => t.id === globalDB.currentTripId);
        const saveCurrentData = () => {
            const trip = getCurrentTrip();
            if(trip) trip.memo = document.getElementById('memo-field').value;
            localStorage.setItem('gst_v4_db', JSON.stringify(globalDB));
        };

        window.onload = () => {
            checkSharedLink();
            lucide.createIcons();
            initMap();
            startTime();
            renderAll();
            updateAISuggestion();
            if(getCurrentTrip()) document.getElementById('memo-field').value = getCurrentTrip().memo;
        };

        // --- Sharing Strategy (No Login Required) ---
        function checkSharedLink() {
            const urlParams = new URLSearchParams(window.location.search);
            const sharedData = urlParams.get('data');
            if (sharedData) {
                try {
                    const decoded = JSON.parse(decodeURIComponent(escape(atob(sharedData))));
                    if (confirm(`"${decoded.name}" 여행 데이터를 내 앱으로 불러올까요?`)) {
                        const newId = Date.now();
                        const newTrip = { ...decoded, id: newId };
                        globalDB.trips.push(newTrip);
                        globalDB.currentTripId = newId;
                        saveCurrentData();
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                } catch (e) { console.error("공유 데이터 오류"); }
            }
        }

        function openShareModal() { document.getElementById('share-modal').classList.add('active'); lucide.createIcons(); }
        function closeShareModal() { document.getElementById('share-modal').classList.remove('active'); }

        function copyShareLink() {
            const trip = getCurrentTrip();
            if (!trip) return;
            const dataToShare = {
                name: trip.name, currency: trip.currency, plans: trip.plans,
                expenses: trip.expenses, checks: trip.checks, memo: trip.memo,
                gallery: trip.gallery.slice(-3) // URL 용량을 위해 최근 3장만 공유
            };
            const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(dataToShare))));
            const shareUrl = `${window.location.origin}${window.location.pathname}?data=${encoded}`;
            
            const el = document.createElement('textarea');
            el.value = shareUrl; document.body.appendChild(el); el.select();
            document.execCommand('copy'); document.body.removeChild(el);
            alert("공유 링크가 복사되었습니다! 카톡에 붙여넣으세요.");
            closeShareModal();
        }

        // --- Rendering & Logic ---
        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([38.27, 128.55], 11);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }

        function startTime() {
            setInterval(() => {
                document.getElementById('clock').innerText = new Date().toLocaleTimeString();
            }, 1000);
        }

        function switchTab(tabId, btn) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('tab-active', 'text-blue-600'));
            if(btn) btn.classList.add('tab-active', 'text-blue-600');
            if(tabId === 'plan') setTimeout(() => map.invalidateSize(), 300);
            lucide.createIcons();
        }

        function renderAll() {
            const trip = getCurrentTrip();
            if (!trip) return;

            document.getElementById('current-trip-name').innerText = trip.name;
            document.getElementById('current-currency').innerText = trip.currency;
            document.getElementById('set-trip-name').value = trip.name;
            document.getElementById('set-currency').value = trip.currency;
            
            const rate = globalDB.rates[trip.currency] || 1;
            document.getElementById('rate-display').innerText = `1.00 ${trip.currency} ≈ ${(1350/rate).toFixed(2)} USD`;

            renderPlans();
            renderExpenses();
            renderChecks();
            renderGallery();
            renderTripHistory();
            saveCurrentData();
        }

        function renderPlans() {
            const list = document.getElementById('plan-list');
            list.innerHTML = '';
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            const plans = getCurrentTrip().plans;
            plans.sort((a,b) => a.time.localeCompare(b.time)).forEach(p => {
                list.innerHTML += `<div class="bg-white p-5 rounded-[2rem] shadow-sm border border-slate-100 flex items-center gap-5 fade-in transition-transform active:scale-95">
                    <div class="text-[10px] font-black text-blue-600 uppercase tracking-widest border-r border-slate-100 pr-4">${p.time}</div>
                    <div class="flex-1 font-bold text-sm text-slate-800">${p.title}</div>
                    <button onclick="deletePlan(${p.id})" class="text-slate-200 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>`;
                const m = L.marker([p.lat, p.lng]).addTo(map).bindPopup(p.title);
                markers.push(m);
            });
            if(markers.length > 0) map.fitBounds(new L.featureGroup(markers).getBounds().pad(0.2));
            lucide.createIcons();
        }

        function renderExpenses() {
            const list = document.getElementById('expense-list');
            const trip = getCurrentTrip();
            list.innerHTML = '';
            let total = 0;
            trip.expenses.forEach((ex, idx) => {
                total += ex.amount;
                list.innerHTML += `<div class="flex justify-between items-center p-6 bg-white rounded-3xl shadow-sm border border-slate-50 fade-in">
                    <div>
                        <p class="text-[8px] font-black text-slate-300 uppercase mb-1">${ex.category || 'Travel'}</p>
                        <h4 class="text-sm font-black text-slate-800">${ex.name}</h4>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="text-base font-black text-slate-900">${trip.currency === 'KRW' ? '₩' : trip.currency} ${ex.amount.toLocaleString()}</span>
                        <button onclick="deleteExpense(${idx})" class="text-slate-200"><i data-lucide="x-circle" class="w-5 h-5"></i></button>
                    </div>
                </div>`;
            });
            document.getElementById('total-expense').innerText = `${trip.currency === 'KRW' ? '₩' : trip.currency} ${total.toLocaleString()}`;
            document.getElementById('expense-count').innerText = `${trip.expenses.length} entries`;
            lucide.createIcons();
        }

        function renderTripHistory() {
            const list = document.getElementById('trip-history-list');
            list.innerHTML = '';
            globalDB.trips.forEach(t => {
                const isActive = t.id === globalDB.currentTripId;
                list.innerHTML += `<button onclick="selectTrip(${t.id})" class="trip-card w-full flex justify-between items-center p-5 rounded-2xl ${isActive ? 'bg-slate-900 text-white shadow-xl' : 'bg-slate-50 text-slate-500 border border-slate-100'}">
                    <span class="text-sm font-black">${t.name}</span>
                    <i data-lucide="${isActive ? 'circle-check-big' : 'chevron-right'}" class="w-4 h-4"></i>
                </button>`;
            });
            lucide.createIcons();
        }

        function renderGallery() {
            const list = document.getElementById('gallery-list');
            list.innerHTML = '';
            getCurrentTrip().gallery.forEach((img, idx) => {
                list.innerHTML += `<div class="gallery-item aspect-square rounded-2xl overflow-hidden relative group shadow-sm">
                    <img src="${img}" class="w-full h-full object-cover">
                    <button onclick="deleteImage(${idx})" class="absolute inset-0 bg-black/50 text-white opacity-0 group-hover:opacity-100 flex items-center justify-center"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
                </div>`;
            });
            lucide.createIcons();
        }

        function renderChecks() {
            const list = document.getElementById('check-list');
            list.innerHTML = '';
            getCurrentTrip().checks.forEach((c, idx) => {
                list.innerHTML += `<div class="flex items-center justify-between p-5 bg-white rounded-3xl shadow-sm border border-slate-50">
                    <div class="flex items-center gap-4">
                        <input type="checkbox" ${c.done ? 'checked' : ''} onchange="toggleCheck(${idx})" class="w-5 h-5 rounded-lg text-blue-600">
                        <span class="text-sm font-bold ${c.done ? 'line-through text-slate-300' : 'text-slate-700'}">${c.text}</span>
                    </div>
                    <button onclick="deleteCheck(${idx})" class="text-slate-200"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>`;
            });
            lucide.createIcons();
        }

        // --- Actions ---
        function createNewTrip() {
            const name = prompt("새 여행 테마를 정해주세요:", "베트남 한달살기");
            if (!name) return;
            const newT = { id: Date.now(), name, currency: "KRW", plans: [], expenses: [], gallery: [], checks: [], memo: "" };
            globalDB.trips.push(newT); globalDB.currentTripId = newT.id; renderAll();
        }
        function selectTrip(id) { globalDB.currentTripId = id; renderAll(); document.getElementById('memo-field').value = getCurrentTrip().memo; switchTab('plan'); }
        function updateTripName(val) { if(getCurrentTrip()) { getCurrentTrip().name = val; document.getElementById('current-trip-name').innerText = val; saveCurrentData(); } }
        function updateTripCurrency(val) { if(getCurrentTrip()) { getCurrentTrip().currency = val; renderAll(); } }
        function deletePlan(id) { getCurrentTrip().plans = getCurrentTrip().plans.filter(p => p.id !== id); renderAll(); }
        function deleteExpense(idx) { getCurrentTrip().expenses.splice(idx, 1); renderAll(); }
        function deleteCheck(idx) { getCurrentTrip().checks.splice(idx, 1); renderAll(); }
        function toggleCheck(idx) { getCurrentTrip().checks[idx].done = !getCurrentTrip().checks[idx].done; renderAll(); }
        function deleteImage(idx) { getCurrentTrip().gallery.splice(idx, 1); renderAll(); }
        function addCheck() {
            const inp = document.getElementById('new-check-input');
            if(!inp.value) return;
            getCurrentTrip().checks.push({ text: inp.value, done: false }); inp.value = ""; renderAll();
        }
        function addGalleryImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => { 
                    if(e.target.result.length > 800000) { alert("사진 용량이 너무 커서 압축이 필요합니다."); return; }
                    getCurrentTrip().gallery.push(e.target.result); renderAll(); 
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function updateAISuggestion() {
            const hr = new Date().getHours();
            const trip = getCurrentTrip();
            let msg = hr < 10 ? "상쾌한 아침이에요! <br>첫 번째 목적지로 떠나볼까요?" : 
                      hr < 15 ? "점심 시간입니다. <br>주변 맛집을 AI에게 물어보세요." :
                      hr < 20 ? "오후의 여유, <br>근처 카페에서 일기를 써볼까요?" : "오늘 하루를 마감하며 <br>영수증을 정리해 보세요.";
            document.getElementById('ai-suggestion').innerHTML = msg;
        }

        // --- Gemini AI Assistant ---
        async function startAIVoice() {
            if (!('webkitSpeechRecognition' in window)) { alert("음성 인식을 지원하지 않습니다."); return; }
            const rec = new webkitSpeechRecognition(); rec.lang = 'ko-KR';
            rec.onstart = () => {
                document.getElementById('mic-btn').classList.add('pulse-mic');
                document.getElementById('ai-status').innerText = "사용자의 말을 분석 중...";
            };
            rec.onend = () => {
                document.getElementById('mic-btn').classList.remove('pulse-mic');
                document.getElementById('ai-status').innerText = "AI Assistant Ready";
            };
            rec.onresult = async (event) => {
                const text = event.results[0][0].transcript;
                processVoice(text);
            };
            rec.start();
        }

        async function processVoice(input) {
            const loading = document.getElementById('ai-loading');
            loading.classList.remove('hidden');
            const prompt = `여행 비서입니다. JSON으로 응답하세요. 'expense' (name, amount), 'memo' (text), 'plan' (title, time) 분류.`;
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: input }] }],
                        systemInstruction: { parts: [{ text: prompt }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                const data = await res.json();
                handleAIAction(JSON.parse(data.candidates[0].content.parts[0].text));
            } catch (err) { alert("AI 처리 실패"); } finally { loading.classList.add('hidden'); }
        }

        async function scanReceipt(input) {
            if (!input.files || !input.files[0]) return;
            const loading = document.getElementById('ai-loading');
            loading.classList.remove('hidden');
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64 = e.target.result.split(',')[1];
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: "영수증 {name, amount} 추출" }, { inlineData: { mimeType: "image/png", data: base64 } }] }],
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });
                    const data = await res.json();
                    const ext = JSON.parse(data.candidates[0].content.parts[0].text);
                    if (ext.amount) {
                        getCurrentTrip().expenses.push({ name: ext.name || "AI 영수증", amount: ext.amount, category: "Dining" });
                        renderAll(); switchTab('expense');
                    }
                } catch (e) { alert("스캔 실패"); } finally { loading.classList.add('hidden'); }
            };
            reader.readAsDataURL(input.files[0]);
        }

        function handleAIAction(act) {
            const t = getCurrentTrip();
            if (act.type === 'expense') { t.expenses.push(act.data); switchTab('expense'); }
            else if (act.type === 'memo') { t.checks.push({ text: act.data.text, done: false }); switchTab('memo'); }
            else if (act.type === 'plan') {
                t.plans.push({ id: Date.now(), title: act.data.title, time: act.data.time || "12:00", 
                    lat: 38.27 + (Math.random()*0.1), lng: 128.55 + (Math.random()*0.1) });
                switchTab('plan');
            }
            renderAll();
        }

        function addNewPlan() {
            const title = prompt("장소 이름:"); if(!title) return;
            const time = prompt("시간 (예: 14:00):", "12:00");
            getCurrentTrip().plans.push({ id: Date.now(), title, time, lat: 38.27 + (Math.random()*0.05), lng: 128.55 + (Math.random()*0.05) });
            renderAll();
        }
    </script>
</body>
</html>
